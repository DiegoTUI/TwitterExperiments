<!DOCTYPE html>

<!--
  Para construir un fichero de coordenadas a partir de un access.log de nginx:
  
  grep -o "latitude=\-\?[0-9.]*&longitude=\-\?[0-9.]*" FILENAME | sort | uniq -u | sed 's/&/|/g' | sed 's/=/|/g' | cut -d '|' -f 2,4
-->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
    <head>
        <title>GuideGo Accesses</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style>
    html,body{height:100%;margin:0;padding:.5em;font-family:Arial;}
    p{margin:0;padding:0;}
    #map{position:relative;border:1px solid #000;background-color:#FFFFEE;width:100%;height:85%;margin-top:.5em;}
    </style>
    </head>

    <body>

    <p>Para hacer zoom a una superf√≠cie concreta, pulsar sobre el mapa con la tecla SHIFT pulsada.</p>
    <div id="map"></div>
  
    <script src="//openlayers.org/dev/OpenLayers.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script>

    var map, layer, markers, proj, icon;
    
    function initMap() {
      proj = new OpenLayers.Projection("EPSG:4326");
      map = new OpenLayers.Map('map', {
        projection: new OpenLayers.Projection("EPSG:900913"),
        displayProjection: proj
      });
      map.addControl(new OpenLayers.Control.ZoomBox());
      
      layer = new OpenLayers.Layer.OSM("GuideGo");
      map.addLayer(layer);
    
      markers = new OpenLayers.Layer.Markers("Markers");
      map.addLayer(markers);
    
      map.setCenter(
          new OpenLayers.LonLat(-9.411163,36.173357).transform(
          proj,
          map.getProjectionObject()
        ), 5
      );
      
      map.zoomToMaxExtent();
      
      var size = new OpenLayers.Size(21,25);
      var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
      icon = new OpenLayers.Icon('http://www.openlayers.org/dev/img/marker.png', size, offset);
    }
    
    function getCoords(lat, lon) {
      return new OpenLayers.LonLat(lon, lat).transform(proj, map.getProjectionObject());
    }
    
    $(document).ready(function() {
      initMap();
      //markers.addMarker(new OpenLayers.Marker(getCoords(36.173357,-9.411163), icon.clone()));
      
      // open coords file
      $.get('coords.txt', function(data) {
        var lines = data.split('\n');
        //lines = lines.slice(1,200); // TEMPORAL CROP!
        lines.forEach(function(line) {
          var coords = line.split('|');
          if(coords[0] && coords[1]) {
            markers.addMarker(new OpenLayers.Marker(getCoords(coords[0], coords[1]), icon.clone()));
          }
        });
        map.zoomToExtent(markers.getDataExtent());  
      });
    
    });
    </script>
    
    </body>
</html>